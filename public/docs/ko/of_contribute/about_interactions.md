# 상호작용에 대하여

## 개요

사용자 입력은 `useInputHandlers` 훅에서 처리됩니다.
마우스/터치 이벤트를 감지하고, 타일 좌표를 계산한 후, 타일 상태에 따라 적절한 액션을 실행합니다.

**파일**: `src/hooks/useInputHandlers.ts`

---

## 클릭 유형

| 입력 | 이벤트 | 동작 |
|------|--------|------|
| 좌클릭 | `handleClick()` | 타일 열기 또는 이동 |
| 우클릭 | `handleRightClick()` | 깃발 설정/해제 또는 폭탄 설치 |
| 롱프레스 (500ms) | `handleLongPress()` | 깃발 타일 해체 (DISMANTLE_MINE) |

---

## 좌표 변환

화면 클릭 위치를 타일 그리드 좌표로 변환하는 과정:

```
1. 캔버스 좌표
   마우스 이벤트의 clientX/clientY를 캔버스 기준으로 변환

2. 상대 타일 좌표
   클릭 위치를 타일 크기로 나누어 그리드 내 상대 위치 계산
   (줌 레벨과 타일 간 여백 고려)

3. 절대 월드 좌표
   커서 원점(cursorPosition)을 기준으로 상대 좌표를 조정
   → 서버에 전송할 절대 타일 위치
```

---

## 타일 상태에 따른 동작

### 좌클릭

| 타일 상태 | 인접 (1칸 이내) | 원거리 |
|-----------|----------------|--------|
| 닫힌 타일 | `OPEN_TILES` 전송 → 타일 열기 | A* 경로탐색 → 이동 후 열기 |
| 열린 타일 | 이동 (1칸) | A* 경로탐색 → 이동 |
| 깃발 타일 | 동작 없음 | 인접 열린 타일로 이동 |
| 폭탄 타일 | 동작 없음 | A* 경로탐색 → 이동 |

### 우클릭

| 타일 상태 | 일반 모드 | 폭탄 모드 |
|-----------|-----------|-----------|
| 닫힌 타일 | `SET_FLAG` → 깃발 설정 | `INSTALL_BOMB` → 폭탄 설치 |
| 깃발 타일 | `SET_FLAG` → 깃발 해제 | 동작 없음 |
| 열린 타일 | 동작 없음 | 동작 없음 |

### 롱프레스 (500ms)

| 타일 상태 | 동작 |
|-----------|------|
| 깃발 타일 | `DISMANTLE_MINE` → 깃발 해체 |
| 기타 | 동작 없음 |

---

## A* 경로탐색

**파일**: `src/utils/aStar.ts`

원거리 타일 클릭 시 A* 알고리즘으로 최적 경로를 계산합니다.

### 특징

- **8방향 이동**: 상하좌우 + 대각선
- **이동 불가 타일**: 깃발(Flag) 타일은 장애물로 취급
- **조기 종료**: 목표가 인접 타일이면 전체 탐색 생략
- **비용 계산**: 직선 1.0, 대각선 1.414 (유클리드 거리)

### 경로 실행 흐름

```
A* 경로 계산
  → waypoints 배열 생성 [시작, ..., 목적지]
  ↓
useMovement:
  → MOVE_SPEED (ms) 간격으로 setInterval
  → 각 스텝마다:
      1. 다음 웨이포인트 방향 계산
      2. 커서 1칸 이동
      3. MOVE 이벤트 서버 전송
      4. padtiles() 호출 (이동 방향으로 그리드 시프트)
      5. CSS transform 애니메이션
  → 목적지 도착 시 원래 액션 실행
```

### 이동 속도

기본 이동 간격: `MOVE_SPEED` (ms/타일)

스킬 트리에서 구매한 스킬에 따라 이동 속도가 변합니다:

```typescript
// useSkillTree에서 스피드 배율 계산
const speedMultiplier = purchasedSkills
  .filter(skill => skill.type === 'speed')
  .reduce((mult, skill) => mult * skill.value, 1.0);
```

---

## 채팅

Enter 키로 채팅 입력 모드를 토글합니다:

1. Enter → 채팅 입력창 활성화
2. 메시지 입력
3. Enter → `CHAT` 이벤트 서버 전송
4. 다른 유저에게 말풍선으로 표시 (8초간)

채팅 중에는 이동/클릭 입력이 비활성화됩니다.

---

## 특수 조건

- **기절 상태**: 폭발 3×3 범위 내에 있으면 10초간 모든 입력 비활성화
- **부활 카운트다운**: `inactive` 컴포넌트가 카운트다운 오버레이 표시
- **그리드 밖 클릭**: 무시됨 (범위 체크 후 조기 반환)
