# 타일 렌더링 방법  

이 프로젝트는 애니메이션 효율성을 위해 3개의 `<canvas>` 요소를 사용하여 그래픽을 렌더링합니다:  

1. **타일 캔버스**: 타일을 렌더링.  
2. **상호작용 캔버스**: 커서 경로와 상호작용 범위를 그리기.  
3. **커서 캔버스**: 사용자 커서를 그리기.  

---

## 프레임 생성 방법  

### 0. 시작 및 종료 지점 초기화  

클라이언트의 창 크기와 타일 크기를 기준으로 타일을 초기화하고 시작 및 종료 지점을 설정합니다.  
이는 클라이언트 창에 렌더링할 수 있는 타일 개수를 기준으로 계산됩니다.  
자세한 내용은 `play/page.tsx`에서 확인할 수 있습니다.  

---

### 1. 서버에 연결  

이 Hook은 WebSocket이 열려 있지 않고 시작 및 종료 지점이 정의된 경우 지정된 URL과 뷰 크기를 사용하여 WebSocket을 재연결 시도합니다.  
자세한 내용은 `play/page.tsx`에서 확인할 수 있습니다.  

---

### 2. WebSocket을 사용하여 서버에서 타일 데이터 가져오기  

타일 및 커서 데이터를 서버에서 가져오려면 WebSocket 연결을 설정하고 들어오는 메시지를 수신 대기합니다. 메시지를 수신하면 데이터를 파싱하고 상태를 업데이트합니다.  

- 시작 및 종료 지점을 기준으로 모든 타일을 요청하고, 초기에는 모든 타일을 "??"로 설정합니다.  

**주의사항**:  
- `start_y`와 `end_y` 좌표는 y축이 반전되어 있으므로 반대로 설정합니다.  
- 수신된 데이터를 구조 분해하여 특정 값을 추출합니다.  
- 추출된 값을 `replaceTiles` 함수에서 사용해 타일을 업데이트합니다.  

서버에서 요청된 타일이 전달되면, 더미 데이터 타일을 전달된 타일로 교체합니다.  
자세한 내용은 `play/page.tsx`에서 확인할 수 있습니다.  

---

### 3. Path2D 객체와 폰트 캐싱  

렌더링 성능을 개선하기 위해 Path2D 객체를 캐싱하고, `fontface.load()`를 사용해 로컬 폰트를 Promise 객체로 로드합니다.  
자세한 내용은 `components/canvas/index.tsx`에서 확인할 수 있습니다.  

---

### 4. 캔버스에 타일 렌더링  

모든 속성이 캐싱되면 로딩 상태를 `false`로 설정하고 타일 캔버스에 타일을 렌더링합니다.  
렌더링은 타일 맵, 타일 크기, 커서 위치, 클릭 위치, 색상, 줌 등 속성에 따라 다릅니다.  

- **타일 캔버스**:  
  - 내부 좌표 정의: 그라디언트를 적용할 영역을 설정.  
  - 그라디언트 생성: `createLinearGradient`를 사용해 그라디언트 객체 생성.  
  - 색상 추가: 시작 및 종료 색상을 `addColorStop`으로 지정.  
  - 그라디언트 적용: 채우기 스타일로 설정하고 `fill()`로 타일 렌더링.  

- **상호작용 캔버스**:  
  - 커서 그리기: 사용자 커서를 캔버스에 렌더링.  
  - 클릭된 타일 강조: 클릭된 타일에 테두리를 그려 시각적 피드백 제공.  
  - 경로 그리기: 경로가 존재하면(`paths.length > 0`), 타일 내 중심을 연결하는 선을 그림.  

- **커서 캔버스**:  
  - 캔버스 설정: 다른 사용자 커서를 그리기 위한 캔버스 가져오기.  
  - 이전 그림 지우기: `clearRect`를 사용해 캔버스를 정리.  
  - 커서 그리기:  
    - `cursors` 배열의 각 커서를 순회.  
    - 각 커서의 정확한 위치를 계산.  
    - `drawCursor` 함수를 사용해 위치와 색상이 올바른 커서를 그림.  

자세한 내용은 `components/canvas/index.tsx`에서 확인할 수 있습니다.  

---

### 5. 캔버스 업데이트  

다음 이벤트가 발생하면 캔버스를 업데이트해야 합니다:  

#### 5-1. 클라이언트 커서 위치 변경 시  

이전 타일 로드 방식과 유사하게, 이동 방향에 따라 타일을 로드합니다.  
이동 방향 반대쪽에 타일을 밀어내고 빈 공간을 "??"로 채운 후 타일을 로드 및 교체합니다.  

대각선 이동도 동일한 방식으로 처리됩니다. 이동 방향의 타일을 로드하고, 반대 방향의 타일을 밀어낸 후 빈 공간을 채우고 타일을 교체합니다.  

이후 시작 및 종료 지점을 설정하고, 커서 위치를 기준으로 모든 캔버스를 다시 렌더링합니다.  

#### 5-2. 다른 커서 상태 변경 시  

다른 커서 위치를 기준으로 커서 캔버스를 다시 렌더링합니다.  

#### 5-3. 특정 타일이 업데이트된 경우  

해당 타일을 교체하고 모든 캔버스를 다시 렌더링합니다.  

#### 5-4. 클라이언트가 줌 레벨을 설정한 경우  

시작 및 종료 지점을 설정하고, 커서 위치를 기준으로 모든 캔버스를 다시 렌더링합니다.  